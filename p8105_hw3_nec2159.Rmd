---
title: "p8105_hw3_nec2159"
author: "Nicole Criscuolo"
date: "2025-10-02"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(patchwork)
library(p8105.datasets)
data("instacart") 
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

```{r}
aisle_df =
  instacart |> 
  count(aisle) |> 
  arrange(desc(n))
```

The data set includes `r nrow(instacart)` observations and `r ncol(instacart)` variables. Key variables include information about the product ordered (`product_name`, `department`,`aisle`) and when the order was placed (`order_dow`, `order_hour_of_day`), along with information about the customer's order habits (`reorder`, `order_number`, `days_since_prior_order`). The table gives this information pertaining to each item ordered. In other words, it lists out all the items that were ordered each time they were ordered. The other variables then tell us about the order each item belonged to (each time it was ordered) and other information as described above. 

There are `r nrow(instacart |> count(aisle))` aisles. The top 5 aisles where most items are ordered from are: `r aisle_df |> filter(row_number() < 6) |> pull(aisle)`.

```{r, fig.width = 10, fig.height = 15}
items_ordered_plot = 
aisle_df |>
  filter(n > 10000, n < 160000) |> 
  mutate(aisle = forcats::fct_reorder(aisle, n)) |> 
  ggplot(aes(x = n, y = aisle)) +
  geom_col(aes(fill = "purple"), show.legend = FALSE) +
    labs (
    x = "Number of Items Ordered",
    y = "Aisle",
    title = "Number of Items Ordered from Each Aisle",
    caption = "Data from Instacart"
  ) 

print(items_ordered_plot)
```
This plot verifies what we found above, which is that the top 5 aisles where most items are ordered from are fresh vegetables, fresh fruits, packaged vegetables and fruits, yogurt, and packaged cheese. We can see that the numbers of items ordered from the top 2 aisles, fresh vegetables and fresh fruits, were significantly higher than the numbers of items ordered from the rest of the aisles. Additionally, the bottom 2 aisles out of all the aisles where the number of items ordered exceeds 10000 are butter and oils and vinegars.

```{r}
  instacart |> 
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) |> 
  count(product_name, aisle) |> 
  arrange(desc(n)) |> 
  rename(times_ordered = n) |> 
  group_by(aisle) |> 
  filter(row_number() < 4) |> 
  knitr::kable()
```
The three most popular items in the packaged vegetables and fruits aisle were ordered a significantly larger number of times than the three most popular items in the baking ingredients and dog food care aisles. This makes sense being that we already know the packaged vegetables and fruits aisle is one of the top 5 most popular aisles. Similarly, the three most popular items in the baking ingredients aisle were ordered a significantly larger number of times than the three most popular items in the dog food care aisle. Again this makes sense as our previous plot included baking ingredients (signifying it had over 10000 items ordered) whereas it did not include dog food care (meaning it had less than 10000 items ordered).

```{r}
  instacart |> 
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) |> 
  group_by(order_dow) |> 
  summarize(
    mean_hour_ordered = mean(order_hour_of_day)
  ) |> 
  knitr::kable()
```

Pink lady apples and coffee ice cream appear to be ordered the most on average during hours 12-14 each day. They are ordered the latest on average on day 3 and the earliest on average on day 1.

## Problem 2

```{r message = FALSE}
zip_df =
  read_csv("data/Zip Codes.csv") |> 
  janitor::clean_names() |> 
  select(-state_fips, -file_date, -county) |> 
  distinct(zip_code, .keep_all = TRUE)

zori_df =
  read_csv("data/Zip_zori_NYC.csv") |> 
  pivot_longer(
    cols = "2015-01-31":"2024-08-31",
    names_to = "date",
    values_to = "zori"
  ) |> 
  janitor::clean_names() |> 
  rename(zip_code = region_name) |> 
  select(-region_type, -state_name, -state, -city, -metro) |> 
  separate(date, into = c("year", "month", "day"), sep = "-") |> 
  mutate(borough = case_match(
    county_name,
      "Bronx County" ~ "The Bronx",
      "Kings County" ~ "Brooklyn",
      "New York County" ~ "Manhattan",
      "Queens County" ~ "Queens",
      "Richmond County" ~ "Staten Island"
    )
  ) |> 
  drop_na(zori)

zip_zori_df =
  left_join(zori_df, zip_df) |> 
  arrange(zip_code)
```

There are `r nrow(zip_zori_df |> count(zip_code) |> filter(n == 116))` ZIP codes observed 116 times. There are `r nrow(zip_zori_df |> count(zip_code) |> filter(n < 10))` ZIP codes observed fewer than 10 times. The reason why some ZIP codes are observed rarely and other are observed in each month is most likely is due to how Zillow collected the data or the availability of rental properties in each zip code. It is possible Zillow may have only started collecting data in certain zip codes after a certain point in time or certain zip codes don't have many rental properties to collect data on each month.

```{r}
zip_zori_df |> 
  group_by(borough, year) |> 
  summarize(
    avg_rental_price = mean(zori, na.rm = TRUE)
  ) |> 
  knitr::kable()
```

Each of the boroughs saw an increase in the average rental price from 2015 to 2024. Staten Island is the only borough without data from before 2020. However, Staten Island's average rental price increased from 2020 to 2024. 

```{r} 
prices_by_year_plot =
zip_zori_df |> 
  group_by(year, zip_code, borough) |> 
  summarize(
    avg_rental_price = mean(zori, na.rm = TRUE)
  ) |> 
  ggplot(aes(x = year, y = avg_rental_price)) +
  geom_violin(fill = "blue") +
  labs(
    x = "Year",
    y = "Average Rental Prices by Zip Code",
    title = "Distribution of Average Rental Prices Across Boroughs from 2015-2024",
    caption = "Data from Zillow"
  ) +
  facet_wrap(borough ~ .) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

```{r fig.width = 15, fig.height = 20}
avg_price_plot =
zip_zori_df |> 
  filter(year == 2023) |> 
  group_by(month, zip_code, borough) |> 
  summarize(
    avg_rental_price = mean(zori, na.rm = TRUE)
  ) |> 
  ggplot(aes(x = borough, y = avg_rental_price)) +
  geom_violin(aes(fill = borough)) +
  labs(
    x = "Borough",
    y = "Average Rental Price for Each Zip Code by Month",
    title = "Distribution of Average Rental Prices Across Boroughs in 2023",
    caption = "Data from Zillow"
  ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))

zori_plots = (prices_by_year_plot + avg_price_plot)
zori_plots
ggsave("results/zori_plots.pdf", plot = zori_plots, width = 15, height = 5)
```
In the rental prices across boroughs plot, we can see the distributions of average rental prices by zip code for each year from 2015 to 2024 in each borough. Each borough is similar in the sense that average rent prices appear to increase by year. Manhattan is the borough with the widest range of rental prices, most likely because it is the most densely populated and offers a wide variety of rental options. The Bronx appears to have increased the most in price on average as the centers of each violin plot appear to be increasing almost exponentially. Manhattan had the largest increase in maximum average rental price as it appears to have almost doubled. Lastly, Brooklyn has the widest plots each year signifying many zip codes share similar average rental prices when compared to other boroughs.

In the distribution of average rental prices plot, we can see the distributions of average rental prices grouped by month and zip code for each borough. We see that Manhattan has the widest range of average rental prices throughout the year, which makes sense for the same reason explained above. Staten Island has the widest plot, meaning many zip codes throughout the months in 2023 share similar average rental prices when compared to other boroughs. While Staten Island is the widest overall, the other boroughs, excluding Manhattan, also bulge around the same rental price level where Staten Island's distribution is widest. This means most zip codes across the boroughs (excluding Manhattan) have average rental prices in the $2000-3000 range for the months in 2023. 

## Problem 3

```{r}
demographic_df =
  read_csv("data/nhanes_covar.csv", skip = 4) |> 
  janitor::clean_names()

accelerometer_df =
  read_csv("data/nhanes_accel.csv") |> 
  janitor::clean_names() |> 
  pivot_longer(
    cols = "min1":"min1440",
    names_to = "min",
    values_to = "mims",
    names_prefix = "min"
  ) |> 
  mutate(min = as.numeric(min))
```

```{r}
full_df =
  left_join(accelerometer_df, demographic_df) |> 
  filter(age > 20) |> 
  drop_na(sex, age, bmi, education) |> 
  mutate(sex = case_match(
           sex,
         1 ~ "male",
         2 ~ "female"),
         education = case_match(
           education,
           1 ~ "Less than HS",
           2 ~ "HS Equivalent",
           3 ~ "More than HS"),
         education = fct_relevel(education, c("Less than HS", "HS Equivalent", "More than HS")))
```

```{r}
full_df |> 
  distinct(seqn, education, sex) |> 
  count(education, sex) |> 
  knitr::kable()
```
There are more females than males in the education groups "less than HS" and "more than HS", but not by much. There are significantly more males than females in the "HS equivalent" education group. There are significantly more males and females in the "more than HS" education category than the other education categories. 

```{r}
full_df |> 
  distinct(seqn, education, age, sex) |>
  ggplot(aes(x = education, y = age, group_by = sex)) +
  geom_boxplot(aes(fill = sex)) +
  labs(
    x = "Education",
    y = "Age",
    title = "Age Distributions for Men and Women in Each Education Category",
    caption = "Data from NHANES Study"
  )
```

The age distributions of males and females appear to differ the most for the education category "HS equivalent." In this education category, the females tend to be older than the males. The age distributions of males and females appear to be very similar to each other in both the "less than HS" and "more than HS" education categories. 

```{r}
full_df |> 
  group_by(seqn, age, education, sex) |> 
  summarize(
    total_activity = sum(mims)
  ) |> 
  ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point(size = 0.5) +
  geom_smooth(se = FALSE) +
  facet_grid(. ~ education) +
  labs(
    x = "Age",
    y = "Total Daily Activity",
    title = "Total Daily Activity by Age, Sex, and Education Level",
    caption = "Data from NHANES Study"
  )
```

The "more than HS" education category is the group where the total activity for both males and females varies the least by age. In this group, there is a slight decline in total daily activity around age 60, which we could expect. The "less than HS" education category is the group where the total activity for both males and females declines the most with age. In this group, there is a steady decline in total daily activity, with a spike in both males and females around age 60. In the "HS equivalent" education group, the total daily activity of females varies more by age than the total daily activity of males by age. In this group, there is an overall decline but there is a peak around age 40 and a valley around age 60 for both males and females. It makes sense that the most educated group has the most consistent total daily activity by age, as these individuals most likely understand the benefits of exercising and have the time and means to do so. Similarly, individuals with the least amount of education most likely do not have the time or means to exercise consistently throughout the course of their life. 

```{r}
full_df |> 
  ggplot(aes(x = min, y = mims, color = sex)) +
  geom_point() +
  geom_smooth(se = FALSE, color = "blue") +
  facet_grid(sex ~ education) +
  scale_x_continuous(
    breaks = c(1, 360, 720, 1080, 1440),
    labels = c("0", "6", "12", "18", "24")
  )+
  labs(
    x = "Hour",
    y = "Movement Summary Unit",
    title = "24 Hour Activity by Sex and Education Level",
    caption = "Data from NHANES Study"
  )
```

The trends in 24 hour activity for males and females for all education groups are relatively similar. There is minimal activity from 12-6 am, with most of the activity starting for each group and sex around 6am. Throughout the day, the movement is pretty consistent for all groups and both sexes throughout the day. Looking closely, females and males in the education groups "less than HS" and "HS equivalent" show a very slight decline for the rest of the day after 6am. Additionally, females and males in the "more than HS" education category don't appear to decline until around 8pm.



